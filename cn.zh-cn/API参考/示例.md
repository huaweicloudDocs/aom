# 示例<a name="ZH-CN_TOPIC_0118852425"></a>

本节以查询指标接口为例，详细描述接口调用的流程。查询指标接口用于查询系统当前可监控的指标列表，可以指定指标命名空间、指标名称、维度、所属资源的编号（格式为：resType\_resId），分页查询的起始位置和返回的最大记录条数。本示例中通过命名空间+应用名称+集群名称的方式实现查询指标。

实现查询应用列表接口调用流程如下：

1.  首先，获取Token认证，因为在后续的请求中需要将token放到请求消息头中作为认证；
2.  其次，构造调用查询应用列表接口的请求消息，构造完成并发起请求；
3.  最后，查看获取到响应消息，分析调用查询应用列表接口是否成功。

## 前提准备<a name="section84211517165514"></a>

1.  存在可监控的指标列表。命名空间为应用指标，指标维度中应用名称（appName）为demo、集群名称（clusterName）为test。
2.  已获取IAM和AOM的Endpoint；此例中IAM的Endpoint以_**iam\_Endpoint**_代替，AOM的Endpoint以**_aom\_Endpoint_**代替。

## 操作步骤<a name="section076617456557"></a>

1.  获取Token认证

    1.  发送“POST https://_**IAM的Endpoint**_/v3/auth/tokens”，此处IAM的Endpoint以iam\_Endpoint代替，POST https://**_iam\_Endpoint_**/v3/auth/tokens。
    2.  请求响应成功后在响应消息头中包含的“X-Subject-Token”的值即为Token值。

        ```
        X-Subject-Token：MIIRpQYJKoZIhvcNAQcCoIIRljCCEZICAQExDTALBglghkgBZQMEAgEwgg-zBg******kqhkiG9w0BBwGggg
        ```


    请求内容示例如下：

    ```
    {
      "auth": {
        "identity": {
          "methods": [
            "password"
          ],
          "password": {
            "user": {
              "name": "username",    //username为用户名，请根据实际情况替换。
              "password": "******",    //******为用户密码，请根据实际情况替换。
              "domain": {
                "name": "domainname"    //domainname为域名，请根据实际情况替换。
              }
            }
          }
        },
        "scope": {
          "project": {
            "name": "cn-north-1"    //cn-north-1为区域名，请根据实际情况替换。
    
          }
        }
      }
    }
    ```

2.  构造请求消息并发送

    每一个请求通常由三部分组成，分别是：请求行、请求消息头、请求正文\(可选\)。请求消息构造完成之后，发送该消息等待响应。

    1.  请求行

        POST https://Endpoint/v1/\{projectId\}/ams/metrics

        Endpoint 为AOM的Endpoint，此处以_**aom\_Endpoint**_代替。

        \{projectId\}为路径参数

        <a name="zh-cn_topic_0082840620_table188831512164613"></a>
        <table><thead align="left"><tr id="zh-cn_topic_0082840620_row1887101211467"><th class="cellrowborder" valign="top" width="33%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0082840620_p68882012144611"><a name="zh-cn_topic_0082840620_p68882012144611"></a><a name="zh-cn_topic_0082840620_p68882012144611"></a>参数</p>
        </th>
        <th class="cellrowborder" valign="top" width="33%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0082840620_p118891812134613"><a name="zh-cn_topic_0082840620_p118891812134613"></a><a name="zh-cn_topic_0082840620_p118891812134613"></a>参数类型</p>
        </th>
        <th class="cellrowborder" valign="top" width="34%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0082840620_p178891112184611"><a name="zh-cn_topic_0082840620_p178891112184611"></a><a name="zh-cn_topic_0082840620_p178891112184611"></a>描述</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="zh-cn_topic_0082840620_row0890131264616"><td class="cellrowborder" valign="top" width="33%" headers="mcps1.1.4.1.1 "><p id="zh-cn_topic_0082840620_p142618296479"><a name="zh-cn_topic_0082840620_p142618296479"></a><a name="zh-cn_topic_0082840620_p142618296479"></a>projectId</p>
        </td>
        <td class="cellrowborder" valign="top" width="33%" headers="mcps1.1.4.1.2 "><p id="zh-cn_topic_0082840620_p1189291214463"><a name="zh-cn_topic_0082840620_p1189291214463"></a><a name="zh-cn_topic_0082840620_p1189291214463"></a>string</p>
        </td>
        <td class="cellrowborder" valign="top" width="34%" headers="mcps1.1.4.1.3 "><p id="zh-cn_topic_0082840620_p315654994615"><a name="zh-cn_topic_0082840620_p315654994615"></a><a name="zh-cn_topic_0082840620_p315654994615"></a>工程ID</p>
        </td>
        </tr>
        </tbody>
        </table>

        用户Token认证过程中，请求响应成功后在响应消息体中包含\{projectId\}值，_**"id":"12ff18574dfe4b92......"**_。

        请求行内容为：

        https://_**aom\_Endpoint**_/v1/_**12ff18574dfe4b92......**_/ams/metrics

    2.  请求消息头

        X-Auth-Token，此值即为在用户Token认证中得到的“X-Subject-Token”的值，

        X-Auth-Token：_**MIIRpQYJKoZIhvcNAQcCoIIRljCCEZICAQExDTALBglghkgBZQMEAgEwgg-zBg\*\*\*\*\*\*kqhkiG9w0BBwGggg**_

        Content-Type：_**application/json;charset=utf8**_

    3.  请求正文

        ```
        {
            "metricItems": [
                {
                    "namespace": "PAAS.CONTAINER",
                    "dimensions":[
                        {
                            "name":"appName",
                            "value":"demo"
                        },
                        {
                            "name":"clusterName",
                            "value":"test" 
                        }
                    ]
                }
            ]
        }
        ```


3.  响应消息

    请求消息发送成功，得到响应消息。

    响应结果：

    ```
    { 
        "errorCode": "SVCSTG_AMS_2000000", 
        "errorMessage": "success", 
        "metaData": { 
          "count": 1, 
          "start": null, 
          "total": 1 
        }, 
        "metrics": [{ 
            "namespace": "abc", 
            "metricName": "cpuUsage", 
            "unit":"Percent", 
            "dimensions": [{ 
                        "name": "instance_id", 
                        "value": "demo1" 
            }]     
        }] 
    }
    ```

    响应结果有参数errorCode（响应错误码）、errorMessage（响应错误信息描述），metaData和metrics都表示得到响应详情。

    metrics参数中的内容为通过命名空间+应用名称+集群名称的方式查询到的指标信息。


